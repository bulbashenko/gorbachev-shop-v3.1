{% extends "admin/change_list.html" %}
{% load static %}

{% block content %}
<div class="analytics-dashboard">
    <!-- Summary Cards -->
    <div class="summary-cards">
        <div class="card">
            <h3>Общие продажи</h3>
            <p class="number">${{ dashboard_data.summary.total_sales|floatformat:2 }}</p>
        </div>
        <div class="card">
            <h3>Заказы</h3>
            <p class="number">{{ dashboard_data.summary.total_orders }}</p>
        </div>
        <div class="card">
            <h3>Новые клиенты</h3>
            <p class="number">{{ dashboard_data.summary.new_customers }}</p>
        </div>
        <div class="card">
            <h3>Возвраты</h3>
            <p class="number">{{ dashboard_data.summary.total_returns }}</p>
        </div>
    </div>

    <!-- Charts -->
    <div class="charts-section">
        <div class="chart-container">
            <h2>Тренд продаж</h2>
            <div id="sales-chart"></div>
        </div>
    </div>

    <!-- Tables Section -->
    <div class="tables-section">
        <div class="top-products">
            <h2>Топ продуктов</h2>
            <table>
                <thead>
                    <tr>
                        <th>Продукт</th>
                        <th>Продажи</th>
                    </tr>
                </thead>
                <tbody>
                    {% for product in dashboard_data.top_products %}
                    <tr>
                        <td>{{ product.product__name }}</td>
                        <td>${{ product.total_revenue|floatformat:2 }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div class="categories">
            <h2>Категории</h2>
            <table>
                <thead>
                    <tr>
                        <th>Категория</th>
                        <th>Продажи</th>
                    </tr>
                </thead>
                <tbody>
                    {% for category in dashboard_data.category_distribution %}
                    <tr>
                        <td>{{ category.category__name }}</td>
                        <td>${{ category.total_sales|floatformat:2 }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Customer Segments -->
    <div class="customer-segments">
        <h2>Сегменты клиентов</h2>
        <div class="segment-cards">
            {% for segment, count in dashboard_data.rfm_distribution.items %}
            <div class="segment-card">
                <h4>{{ segment|title }}</h4>
                <p>{{ count }}</p>
            </div>
            {% endfor %}
        </div>
    </div>

    {{ block.super }}
</div>
{% endblock %}

{% block extrahead %}
{{ block.super }}
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        try {
            var salesData = JSON.parse('{{ dashboard_data.sales_trend|escapejs|safe }}');
            if (salesData && Array.isArray(salesData) && salesData.length > 0) {
                var dates = salesData.map(function (item) { return item.date; });
                var values = salesData.map(function (item) { return parseFloat(item.total_sales); });

                var trace = {
                    x: dates,
                    y: values,
                    type: 'scatter',
                    mode: 'lines+markers',
                    line: { color: '#2ecc71' }
                };

                var layout = {
                    margin: { t: 10, r: 10, b: 30, l: 60 },
                    height: 300,
                    yaxis: {
                        title: 'Продажи'
                    },
                    xaxis: {
                        title: 'Дата'
                    }
                };

                Plotly.newPlot('sales-chart', [trace], layout);
            }
        } catch (error) {
            console.error('Error creating chart:', error);
        }
    });
</script>
<style>
    .analytics-dashboard {
        padding: 20px;
    }

    .summary-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .card {
        background: white;
        padding: 20px;
        border-radius: 4px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .card h3 {
        margin: 0;
        color: #666;
        font-size: 14px;
    }

    .card .number {
        font-size: 24px;
        margin: 10px 0;
        color: #2ecc71;
    }

    .charts-section {
        background: white;
        padding: 20px;
        border-radius: 4px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        margin-bottom: 30px;
    }

    .tables-section {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 30px;
    }

    .top-products,
    .categories {
        background: white;
        padding: 20px;
        border-radius: 4px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    table {
        width: 100%;
        border-collapse: collapse;
    }

    th,
    td {
        padding: 8px;
        text-align: left;
        border-bottom: 1px solid #eee;
    }

    th {
        background: #f8f9fa;
    }

    .customer-segments {
        background: white;
        padding: 20px;
        border-radius: 4px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .segment-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 20px;
        margin-top: 20px;
    }

    .segment-card {
        text-align: center;
        padding: 15px;
        border: 1px solid #eee;
        border-radius: 4px;
    }

    .segment-card h4 {
        margin: 0;
        color: #666;
    }

    .segment-card p {
        font-size: 24px;
        margin: 10px 0;
    }
</style>
{% endblock %}